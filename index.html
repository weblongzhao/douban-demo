<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <meta content="never" name="referrer">
            <meta content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0" name="viewport"/>
            <link href="//at.alicdn.com/t/font_621135_20bgu8c1ndvlsor.css" rel="stylesheet" type="text/css">
                <style media="screen" type="text/css">
                    * {
            margin:0;
            padding:0;
            box-sizing:border-box;
        }

        html,
        body {
            height:100%;
        }
        .clearfix::after{
            content:"";
            display:block;
            clear:both;
        }

        a{
            text-decoration:none;

        }

        .container .item {
            border-bottom:1px solid #ccc;
        }

        .container .item .cover {
            float: left;
        }

        .container .item .cover img,
        .container .item .cover
        {
            width: 70px;
        }

        .container .item .detail {
            margin-left:75px;
        }

        .container .item .detail .extra {
            font-size:12px;
            color:#999;
        }

        main {
            position:relative;
            height: 100%;
        }

        main section {
            height:calc(100% - 50px);
            overflow:scroll;
            display: none;
        }

        main section:nth-child(1){
            display:block;
        }

        .loading {
            text-align:center;
        }

        .loading span {
            display:inline-block;
            animation:wait 0.5s linear infinite;
        }
        @keyframes wait {
            0% {transform:rotate(0deg);}
            100% {transform:rotate(360deg);}
        }
        footer {
            width: 100%;
            display:flex;
            position:absolute;
            bottom:0;

        }

        footer .active {
            color:#FF5722;
        }

        footer div {
            flex:1;
            text-align:center;
        }

        footer span {
            height: 25px;
            display: block;
            align-items: center;
        }
                </style>
                <title>
                    豆瓣demo
                </title>
                <script src="https://cdn.bootcss.com/jquery/2.1.1/jquery.min.js">
                </script>
            </link>
        </meta>
    </head>
    <body>
        <main>
            <section id="top250">
                <div class="container">
                    <!-- <div class="item">
                    <a class="clearfix" href="">
                        <div class="cover">
                            <img src="http://img3.doubanio.com/view/photo/s_ratio_poster/public/p510876377.jpg" alt="">
                        </div>
                        <div class="detail">
                            <h2>肖申克的救赎</h2>
                            <div class="extra">
                                9.6分/1234323收藏
                            </div>
                            <div class="extra">
                                1994/犯罪/剧情
                            </div>
                            <div class="extra">
                                导演:弗兰克.德拉邦特
                            </div>
                            <div class="extra">
                                主演:蒂姆·罗宾斯、摩根·弗里曼、鲍勃·冈顿
                            </div>

                        </div>
                    </a>
                </div> -->
                </div>
                <div class="loading">
                    <span class="iconfont icon-loading">
                    </span>
                </div>
            </section>
            <section id="beimei">
                <div class="container">
                    <!-- <div class="item">
                    <a class="clearfix" href="">
                        <div class="cover">
                            <img src="http://img3.doubanio.com/view/photo/s_ratio_poster/public/p510876377.jpg" alt="">
                        </div>
                        <div class="detail">
                            <h2>肖申克的救赎</h2>
                            <div class="extra">
                                9.6分/1234323收藏
                            </div>
                            <div class="extra">
                                1994/犯罪/剧情
                            </div>
                            <div class="extra">
                                导演:弗兰克.德拉邦特
                            </div>
                            <div class="extra">
                                主演:蒂姆·罗宾斯、摩根·弗里曼、鲍勃·冈顿
                            </div>

                        </div>
                    </a>
                </div> -->
                </div>
                <div class="loading">
                    <span class="iconfont icon-loading">
                    </span>
                </div>
            </section>
            <section id="search">
                <div class="search">
                    <input id="sear" type="text">
                    <button id="btn" type="button">搜索</button>
                </div>
                <div class="container">
                    <!-- <div class="item">
                    <a class="clearfix" href="">
                        <div class="cover">
                            <img src="http://img3.doubanio.com/view/photo/s_ratio_poster/public/p510876377.jpg" alt="">
                        </div>
                        <div class="detail">
                            <h2>肖申克的救赎</h2>
                            <div class="extra">
                                9.6分/1234323收藏
                            </div>
                            <div class="extra">
                                1994/犯罪/剧情
                            </div>
                            <div class="extra">
                                导演:弗兰克.德拉邦特
                            </div>
                            <div class="extra">
                                主演:蒂姆·罗宾斯、摩根·弗里曼、鲍勃·冈顿
                            </div>

                        </div>
                    </a>
                </div> -->
                </div>
                <div class="loading">
                    <span class="iconfont icon-loading">
                    </span>
                </div>
            </section>
        </main>
        <footer>
            <div class="active">
                <span class="iconfont icon-paihangbang">
                </span>
                <span>
                    Top250
                </span>
            </div>
            <div>
                <span class="iconfont icon-beimei">
                </span>
                <span>
                    北美
                </span>
            </div>
            <div>
                <span class="iconfont icon-search">
                </span>
                <span>
                    搜索
                </span>
            </div>
        </footer>
        <script type="text/javascript">
        var app = {
            init:function(){
                top250Page.init()
                beimeiPage.init()
                searchPage.init()
                this.bind()
               /* beimeiPage.init()
                  searchPage.init()*/
            },
            bind:function(){
                $("footer>div").on("click",function(){
                    var $index = $(this).index();
                    console.log($index)
                     $("main section").eq($index).fadeIn().siblings().fadeOut();
                    $(this).addClass("active").siblings().removeClass("active") ;
                })
            }
        }
        var top250Page = {
            init:function(){
                this.view=$("#top250")
                this.container =$(".container")
                console.log("top250")
                this.index=0;
                this.bind()
                this.render()
            },
            bind:function(){
                var _this = this ;
                var time=null;
                this.view.on("scroll",function(e){
                    if(time){
                        clearTimeout(time);
                    }
                    time=setTimeout(function(){
                        var view = _this.view.height();
                        var height = _this.container.height() ;
                        //滚动到底部
                         if(view+$("#top250").scrollTop() > height-20){
                            console.log("scrollBottom")
                            $("#top250 .loading span").show(100)
                            _this.render()
                         }
                    },200)

                })
            },
            getData:function(callback){
                var _this = this;
                $.ajax({
                    url:"https://api.douban.com/v2/movie/top250",
                    dataType:"jsonp",
                    type:"get",
                    data:{
                        start:_this.index,
                        count:10
                    }
                }).done(function(res){
                    _this.index+=10;
                    callback(res)
                })
            },
            render: function(){
                this.getData(function(x){
                    console.log(x)
                    /*数据处理*/
                var sub = x.subjects;
                    sub.forEach(function(item,index){
                    var casts=[] ;
                    item.casts.forEach(function(a){
                        casts.push(a.name) ;
                    }) ;
                     var node = `
                    <div class="item">
                        <a class="clearfix" href="">
                            <div class="cover">
                                <img src="http://img3.doubanio.com/view/photo/s_ratio_poster/public/p510876377.jpg" alt="">
                            </div>
                            <div class="detail">
                                <h2>肖申克的救赎</h2>
                                <div class="extra">
                                    9.6分/1234323收藏
                                </div>
                                <div class="extra">
                                    1994/犯罪/剧情
                                </div>
                                <div class="extra">
                                    导演:弗兰克.德拉邦特
                                </div>
                                <div class="extra">
                                    主演:蒂姆·罗宾斯、摩根·弗里曼、鲍勃·冈顿
                                </div>

                            </div>
                        </a>
                    </div>
                    `
                   var $node= $(node) ;
                        $($node).find(".cover > img").attr("src",item.images.large) ;
                        $node.find(".detail > h2").text(item.title) ;
                        $node.find(".detail .extra").eq(0).text(item.rating.average+"分/"+item.collect_count+"收藏") ;
                        $node.find(".detail .extra").eq(1).text(item.year+""+item.genres.join("/")) ;
                        $node.find(".detail .extra").eq(2).text("导演:"+item.directors[0].name) ;
                        $node.find(".detail .extra").eq(3).text("主演:"+casts.join("、")) ;
                        $("#top250 .container").append($node);
                   })
                   $("#top250 .loading span").hide()
                    /*数据处理end*/
                })
            }
        }
        var beimeiPage = {
            init:function(){
                this.view=$("#beimei")
                this.container =$(".container")
                this.index=0;
                this.bind()
                this.render()
            },
            bind:function(){

            },
            getData:function(callback){
                var _this = this;
                $.ajax({
                    url:"https://api.douban.com/v2/movie/us_box",
                    dataType:"jsonp",
                    type:"get",
                    data:{
                        start:_this.index,
                        count:10
                    }
                }).done(function(res){
                    _this.index+=10;
                    callback(res)
                })
            },
            render:function(){
                console.log("北美")

                this.getData(function(x){
                        /*数据处理*/
                console.log(x)
                var sub = x.subjects;
                    sub.forEach(function(item,index){
                    var casts=[] ;
                    item.subject.casts.forEach(function(a){
                        casts.push(a.name) ;
                    }) ;
                     var node = `
                    <div class="item">
                        <a class="clearfix" href="">
                            <div class="cover">
                                <img src="http://img3.doubanio.com/view/photo/s_ratio_poster/public/p510876377.jpg" alt="">
                            </div>
                            <div class="detail">
                                <h2>肖申克的救赎</h2>
                                <div class="extra">
                                    9.6分/1234323收藏
                                </div>
                                <div class="extra">
                                    1994/犯罪/剧情
                                </div>
                                <div class="extra">
                                    导演:弗兰克.德拉邦特
                                </div>
                                <div class="extra">
                                    主演:蒂姆·罗宾斯、摩根·弗里曼、鲍勃·冈顿
                                </div>

                            </div>
                        </a>
                    </div>
                    `
                   var $node= $(node) ;
                        $($node).find(".cover > img").attr("src",item.subject.images.large) ;
                        $node.find(".detail > h2").text(item.subject.title) ;
                        $node.find(".detail .extra").eq(0).text(item.subject.rating.average+"分/"+item.subject.collect_count+"收藏") ;
                        $node.find(".detail .extra").eq(1).text(item.subject.year+""+item.subject.genres.join("/")) ;
                        $node.find(".detail .extra").eq(2).text("导演:"+item.subject.directors[0].name) ;
                        $node.find(".detail .extra").eq(3).text("主演:"+casts.join("、")) ;
                        $("#beimei .container").append($node);
                   })
                   $("#beimei .loading span").hide()
                    /*数据处理end*/
                })
            }
        }

        var searchPage={
            init:function(){
                this.view=$("#search");
                this.container =$(".container");
                this.bind() ;
                this.query="";
                this.index=0;
            },
            bind:function(){
                var _this=this;
                console.log(this)
                $("#btn").on('click',function(){
                    _this.query=$("#sear").val()
                   _this.render()
                })
                //滚动底部检测
                var time=null;
                this.view.on("scroll",function(e){
                    console.log(this.query)
                    if(time){
                        clearTimeout(time);
                    }
                    time=setTimeout(function(){
                        var view = _this.view.height();
                        var height = _this.container.height() ;
                        //滚动到底部
                         if(view+$("#search").scrollTop() > height-20){
                            console.log("scrollBottom")
                            $("#search .loading span").show(100)
                            _this.render()
                         }
                    },200)

                })
            },
            getData:function(callback){
                var _this = this;
                $.ajax({
                    url:"https://api.douban.com/v2/movie/search",
                    dataType:"jsonp",
                    type:"get",
                    data:{
                        q:_this.query,
                        start:_this.index,
                        count:10
                    }
                }).done(function(res){
                    //_this.query="";
                    _this.index+=10;
                    callback(res)
                })
            },
            render:function(){
                //$("#search .container").empty()
                this.getData(function(x){
                    console.log(111)
                    console.log(x)
                    /*数据处理*/
                var sub = x.subjects;
                    sub.forEach(function(item,index){
                    var casts=[] ;
                    item.casts.forEach(function(a){
                        casts.push(a.name) ;
                    }) ;
                    
                     var node = `
                    <div class="item">
                        <a class="clearfix" href="">
                            <div class="cover">
                                <img src="http://img3.doubanio.com/view/photo/s_ratio_poster/public/p510876377.jpg" alt="">
                            </div>
                            <div class="detail">
                                <h2>肖申克的救赎</h2>
                                <div class="extra">
                                    9.6分/1234323收藏
                                </div>
                                <div class="extra">
                                    1994/犯罪/剧情
                                </div>
                                <div class="extra">
                                    导演:弗兰克.德拉邦特
                                </div>
                                <div class="extra">
                                    主演:蒂姆·罗宾斯、摩根·弗里曼、鲍勃·冈顿
                                </div>

                            </div>
                        </a>
                    </div>
                    `
                   var $node= $(node) ;
                        $($node).find(".cover > img").attr("src",item.images.large) ;
                        $node.find(".detail > h2").text(item.title) ;
                        $node.find(".detail .extra").eq(0).text(item.rating.average+"分/"+item.collect_count+"收藏") ;
                        $node.find(".detail .extra").eq(1).text(item.year+""+item.genres.join("/")) ;
                        $node.find(".detail .extra").eq(2).text("导演:"+item.directors[0].name) ;
                        $node.find(".detail .extra").eq(3).text("主演:"+casts.join("、")) ;
                        $("#search .container").append($node);
                   })
                   $("#search .loading span").hide()
                    /*数据处理end*/
                })
            }
        }
        app.init()




    //优化前

    // var index=0 ;
    //     $(document).ready(function(){
    //         $("footer>div").on("click",function(){
    //             var $index = $(this).index();
    //             console.log($index)
    //              $("main section").eq($index).fadeIn().siblings().fadeOut();
    //             $(this).addClass("active").siblings().removeClass("active") ;
    //         })
    //         $.ajax({
    //             url:"https://api.douban.com/v2/movie/top250",
    //             dataType:"jsonp",
    //             type:"get",
    //             data:{
    //                 start:index,
    //                 count:10
    //             }
    //         }).done(function(x){
    //             console.log(x.subjects) ;
    //             index+=10;
            //     var sub = x.subjects;
            //     sub.forEach(function(item,index){
            //     var casts=[] ;
            //     item.casts.forEach(function(a){
            //         casts.push(a.name) ;
            //     }) ;
            //      var node = `
            //     <div class="item">
            //         <a class="clearfix" href="">
            //             <div class="cover">
            //                 <img src="http://img3.doubanio.com/view/photo/s_ratio_poster/public/p510876377.jpg" alt="">
            //             </div>
            //             <div class="detail">
            //                 <h2>肖申克的救赎</h2>
            //                 <div class="extra">
            //                     9.6分/1234323收藏
            //                 </div>
            //                 <div class="extra">
            //                     1994/犯罪/剧情
            //                 </div>
            //                 <div class="extra">
            //                     导演:弗兰克.德拉邦特
            //                 </div>
            //                 <div class="extra">
            //                     主演:蒂姆·罗宾斯、摩根·弗里曼、鲍勃·冈顿
            //                 </div>

            //             </div>
            //         </a>
            //     </div>
            //     `
            //    var $node= $(node) ;
            //         $($node).find(".cover > img").attr("src",item.images.large) ;
            //         $node.find(".detail > h2").text(item.title) ;
            //         $node.find(".detail .extra").eq(0).text(item.rating.average+"分/"+item.collect_count+"收藏") ;
            //         $node.find(".detail .extra").eq(1).text(item.year+""+item.genres.join("/")) ;
            //         $node.find(".detail .extra").eq(2).text("导演:"+item.directors[0].name) ;
            //         $node.find(".detail .extra").eq(3).text("主演:"+casts.join("、")) ;
            //         $("#top250 .container").append($node);
            //    })
            //    $("#top250 .loading span").hide()
            //

    //         //滚动监听
    //         var time=null;
    //         $("#top250").on("scroll",function(e){
    //             if(time){
    //                 clearTimeout(time);
    //             }
    //             time=setTimeout(function(){
    //                 var view = $("#top250").height();
    //                 var height = $(".container").height() ;
    //                 //view =$("#top250").height()  height=$(".container").height()
    //                     console.log(height)
    //                     console.log(view+$("#top250").scrollTop())
    //                 //滚动到底部
    //                 if(view+$("#top250").scrollTop() > height-20){
    //                     console.log("show")
    //                     $("#top250 .loading span").show(100)
    //              /*获取数据并渲染dom*/
    //              $.ajax({
    //             url:"https://api.douban.com/v2/movie/top250",
    //             dataType:"jsonp",
    //             type:"get",
    //             data:{
    //                 start:index,
    //                 count:10
    //             }

    //         }).done(function(x){
    //             console.log(x.subjects) ;
    //             index+=10;
    //             var sub = x.subjects;
    //           sub.forEach(function(item,index){
    //             var casts=[] ;
    //             item.casts.forEach(function(a){
    //                 casts.push(a.name) ;
    //             })
    //              var node = `
    //             <div class="item">
    //                 <a class="clearfix" href="">
    //                     <div class="cover">
    //                         <img src="http://img3.doubanio.com/view/photo/s_ratio_poster/public/p510876377.jpg" alt="">
    //                     </div>
    //                     <div class="detail">
    //                         <h2>肖申克的救赎</h2>
    //                         <div class="extra">
    //                             9.6分/1234323收藏
    //                         </div>
    //                         <div class="extra">
    //                             1994/犯罪/剧情
    //                         </div>
    //                         <div class="extra">
    //                             导演:弗兰克.德拉邦特
    //                         </div>
    //                         <div class="extra">
    //                             主演:蒂姆·罗宾斯、摩根·弗里曼、鲍勃·冈顿
    //                         </div>

    //                     </div>
    //                 </a>
    //             </div>
    //             `
    //            var $node= $(node) ;
    //                 $($node).find(".cover > img").attr("src",item.images.large) ;
    //                 $node.find(".detail > h2").text(item.title) ;
    //                 $node.find(".detail .extra").eq(0).text(item.rating.average+"分/"+item.collect_count+"收藏") ;
    //                 $node.find(".detail .extra").eq(1).text(item.year+""+item.genres.join("/")) ;
    //                 $node.find(".detail .extra").eq(2).text("导演:"+item.directors[0].name) ;
    //                 $node.find(".detail .extra").eq(3).text("主演:"+casts.join("、")) ;

    //                 $("#top250 .container").append($node);
    //            })
    //         $("#top250 .loading span").hide()

    //         })
    //          /*获取数据并渲染dom 结束*/
    //                  console.log('scrollbottom')
    //                 }
    //             },100)
    //         })
    //     })
        </script>
    </body>
</html>